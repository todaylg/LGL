<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta
      name="viewport"
      content="width=device-width, minimal-ui, viewport-fit=cover, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no"
    />
    <title>Multiple Alpha Video(WebGL)</title>
    <link href="assets/main.css" rel="stylesheet" />
  </head>
  <body>
    <script type="module">
      import {
        Renderer,
        Camera,
        Transform,
        Texture,
        Program,
        Geometry,
        Mesh
      } from "../src/Core.js";
      import { Plane } from "../src/Extras.js";
      import TexturesShader from "./shaders/AlphaVideoShader.js";

      {
        const renderer = new Renderer({ dpr: 2 });
        const gl = renderer.gl;
        document.body.appendChild(gl.canvas);
        gl.clearColor(1, 1, 1, 1);

        const camera = new Camera(gl, { fov: 45 });
        camera.position.set(0, 0, 10);
        camera.lookAt([0, 0, 0]);

        function resize() {
          renderer.setSize(window.innerWidth, window.innerHeight);
          camera.perspective({ aspect: gl.canvas.width / gl.canvas.height });
        }
        window.addEventListener("resize", resize, false);
        resize();

        const scene = new Transform();

        // Init empty texture while source loading
        const videoTexture = new Texture(gl, {
          generateMipmaps: false, //多级渐远纹理(Mipmap)
          width: 874,
          height: 960
        });

        let video = document.createElement("video");
        video.src = "assets/dance.mp4";

        video.loop = true;
        video.muted = true;
        video.play();

        // 取上半部分纹理坐标
        let uvCoord = new Float32Array([0, 1, 1, 1, 0, 0.5, 1, 0.5]);
        const videoGeometry = new Plane(gl);

        videoGeometry.addAttribute("topUv", {
          size: 2,
          data: uvCoord
        });

        const videoProgram = new Program(gl, {
          vertex: TexturesShader.vertex,
          fragment: TexturesShader.fragment,
          uniforms: {
            tMap: { value: videoTexture }
          },
          transparent: true,
          cullFace: null
        });

        for (let index = 0; index < 100; index++) {
          const videoMesh = new Mesh(gl, {
            geometry: videoGeometry,
            program: videoProgram
          });
          videoMesh.position.set(
            (Math.random() - 0.5) * 10,
            (Math.random() - 0.5) * 10,
            (Math.random() - 0.5) * 10,
          );
          videoMesh.setParent(scene);
        }

        requestAnimationFrame(update);
        function update() {
          requestAnimationFrame(update);

          // Attach video and/or update texture when video is ready
          if (video.readyState >= video.HAVE_ENOUGH_DATA) {
            if (!videoTexture.image) videoTexture.image = video;
            videoTexture.needsUpdate = true;
          }

          renderer.render({ scene, camera });
        }
      }
    </script>
  </body>
</html>
